# S3を使用したRAPIDデプロイ手順

このドキュメントでは、S3バケットからソースコードを取得してRAPIDアプリケーションをデプロイする方法について説明します。この方法は、GitLabリポジトリへのアクセスが制限されている環境で使用することを想定しています。

## 前提条件

- AWS CLI がインストールされ、適切に設定されていること
- S3バケットへのアクセス権限があること
- jq コマンドがインストールされていること
- zip コマンドがインストールされていること

## 手順

### 1. ソースコードの準備とS3へのアップロード

以下の2つの方法があります：

#### 方法1: bin-s3.shスクリプトを使用する（推奨）

プロジェクトのzipファイルを自動的に作成してS3にアップロードします：

```bash
./bin-s3.sh --s3-bucket <バケット名> --create-zip
```

このコマンドは以下の処理を行います：
- プロジェクトのzipファイルを作成（node_modules、cdk.out、.gitなどのビルドファイルは除外）
- 指定したS3バケットにアップロード
- RAPIDアプリケーションをデプロイ

#### 方法2: 手動でzipファイルを作成してアップロードする

1. ソースコードをZIPファイルにまとめます

   ```bash
   # リポジトリのクローンまたはダウンロード
   git clone <リポジトリURL> rapid
   cd rapid
   
   # ZIPファイルの作成
   cd ..
   zip -r rapid-code.zip rapid
   ```

2. 作成したZIPファイルをS3バケットにアップロードします

   ```bash
   aws s3 cp rapid-code.zip s3://<バケット名>/rapid-code.zip
   ```

3. デプロイスクリプトを実行します

   ```bash
   ./bin-s3.sh --s3-bucket <バケット名>
   ```

### 2. デプロイスクリプトの実行（zipファイルが既にS3にある場合）

```bash
./bin-s3.sh --s3-bucket <バケット名>
```

このスクリプトは以下の処理を行います：
- CloudFormationを使用してCodeBuildプロジェクトを作成
- S3バケットからソースコードをダウンロード
- RAPIDアプリケーションをデプロイ

カスタムパラメータを指定することもできます：

```bash
./bin-s3.sh --s3-bucket <バケット名> --s3-key <S3キー> --auto-migrate false
```

### 利用可能なオプション

- `--s3-bucket`: **必須** - ソースコードが格納されているS3バケット名
- `--s3-key`: ソースコードのZIPファイルのS3キー（デフォルト: rapid-code.zip）
- `--create-zip`: プロジェクトのzipファイルを作成してS3にアップロードする
- `--ipv4-ranges`: フロントエンドWAFで許可するIPv4アドレス範囲（JSON配列形式）
- `--ipv6-ranges`: フロントエンドWAFで許可するIPv6アドレス範囲（JSON配列形式）
- `--disable-ipv6`: IPv6サポートを無効にする
- `--auto-migrate`: デプロイ時に自動的にデータベースマイグレーションを実行するかどうか
- `--cdk-json-override`: CDK設定をオーバーライドするためのJSON文字列

### 注意事項

- S3バケットとCodeBuildプロジェクトは同じAWSアカウント内に存在する必要があります
- ZIPファイルのルート直下にアプリケーションのコードが含まれている必要があります
- デフォルトでは自動マイグレーションが有効になっています。本番環境では `--auto-migrate false` を指定することを検討してください
- `--create-zip` オプションを使用する場合、node_modules、cdk.out、.gitなどのビルドファイルは自動的に除外されます

## トラブルシューティング

### S3バケットへのアクセスエラー

```
指定されたS3オブジェクトが存在しません: s3://<バケット名>/rapid-code.zip
```

- S3バケット名とキーが正しいことを確認してください
- AWS CLIの認証情報が適切に設定されていることを確認してください
- バケットポリシーでCodeBuildからのアクセスが許可されていることを確認してください

### デプロイエラー

ビルドに失敗した場合は、CloudWatch Logsでエラーの詳細を確認できます：

```bash
aws logs get-log-events --log-group-name <ロググループ名> --log-stream-name <ログストリーム名>
```

ロググループ名とログストリーム名はデプロイスクリプトの実行結果に表示されます。
