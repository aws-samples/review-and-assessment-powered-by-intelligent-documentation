# 審査機能実装に関する質問集

このドキュメントは、審査機能の実装に際して発生する可能性のある質問をまとめたものです。バックエンドおよびフロントエンドの開発者が実装を進める上で参考にしてください。

## データベース関連の質問

### 1. モデル定義について

1. **Q: 既存の `Document` モデルから `CheckListDocument` への移行はどのように行うべきですか？**

   - A: 既存の `Document` テーブルをリネームし、関連するすべての外部キー参照も更新する必要があります。移行は prisma によって行われるため、特にスクリプトの実装は必要ありません。

2. **Q: `ReviewDocument` と `CheckListDocument` の違いは何ですか？**

   - A: `CheckListDocument` はチェックリスト作成時に参照されるドキュメントで、`ReviewDocument` は審査対象となるドキュメントです。用途が異なるため、別々のモデルとして定義しています。

3. **Q: `ReviewResult` の `result` フィールドにはどのような値が入りますか？**

   - A: `pass` または `fail` の 2 種類のみです。以前は `warning` も検討されていましたが、要件に基づき削除されました。

4. **Q: 階層構造を持つチェックリスト項目の結果はどのように計算されますか？**
   - A: 親項目の結果は子項目の結果に基づいて計算されます。すべての子項目が `pass` の場合のみ親項目も `pass` となり、一つでも `fail` があれば親項目も `fail` となります。この計算はアプリケーション側で動的に行います。

## バックエンド実装に関する質問

### 1. API 実装について

1. **Q: 審査ジョブの作成後、非同期処理はどのように開始すべきですか？**

   - A: 審査ジョブの作成後、AWS Step Functions または同等のワークフローエンジンを使用して非同期処理を開始します。ジョブ ID をパラメータとして渡し、各チェック項目に対する処理を順次または並列で実行します。
   - StepFunctions の実装はのちに行います。TBD マーカーをつけておいてください。

2. **Q: 信頼度スコア（confidence_score）はどのように計算すべきですか？**

   - A: LLM からの応答に含まれる信頼度情報を使用します。具体的な計算方法は LLM の仕様に依存しますが、閾値は `frontend/src/features/review/constants.ts` に定義します。

3. **Q: 審査結果の階層構造を取得する際のパフォーマンス最適化はどうすべきですか？**

   - A: N+1 問題を避けるため、Prisma の `include` を使用して関連データを一度に取得します。

4. **Q: ユーザーが審査結果を上書きした場合、親項目の結果はどう更新されますか？**
   - A: ユーザーが結果を上書きした場合、その項目の `user_override` フラグを `true` に設定し、親項目の結果を再計算します。再計算は、その項目から根に至るまでのパス上のすべての項目に対して行います。
   - 計算結果は特に DB に保持しません。GET 時に計算して返してください。

### 2. エラーハンドリングについて

1. **Q: LLM の処理中にエラーが発生した場合、どう対応すべきですか？**

   - A: エラーの種類に応じて適切に対応します。一時的なエラーの場合はリトライし、永続的なエラーの場合は審査結果のステータスを `failed` に設定し、エラー情報をメタデータに記録します。

## フロントエンド実装に関する質問

### 1. UI 実装について

1. **Q: 審査結果の階層構造はどのように表示すべきですか？**

   - A: ツリー構造の UI コンポーネントを使用し、親子関係を視覚的に表現します。各項目の結果ステータス（pass/fail）に応じて色分けし、展開/折りたたみ機能を実装してください。

2. **Q: 信頼度スコアが低い項目はどのように表示すべきですか？**

   - A: 信頼度スコアが閾値（`CONFIDENCE_THRESHOLD`）を下回る場合は、警告アイコンを表示し、ユーザーに注意を促します。具体的な UI 表現は、tailwind.config.js に従ってください。

3. **Q: 審査ジョブの進捗状況はどのように表示すべきですか？**

   - A: 審査ジョブ一覧画面にステータスとして表示します。

4. **Q: ユーザーによる結果の上書き機能はどのように実装すべきですか？**
   - A: 各審査結果項目に対して編集ボタンを設置し、クリックするとモーダルフォームを表示します。ユーザーは結果（pass/fail）を変更し、コメントを追加できるようにします。

### 2. データ取得と状態管理について

1. **Q: 審査結果の階層構造データはどのように取得・管理すべきですか？**

   - A: SWR を使用して `/review-jobs/:jobId/results/hierarchy` エンドポイントからデータを取得し、キャッシュします。ユーザーによる上書きがあった場合は、キャッシュを適切に更新します。

2. **Q: 大量のチェック項目がある場合、パフォーマンスはどう確保しますか？**

   - A: まだ考慮しなくて構いません

3. **Q: 審査ジョブのリアルタイム更新はどのように実装すべきですか？**
   - A: SWR の再検証機能を使用して、一定間隔でデータを更新します。一覧画面は定期的に更新します。

## LLM 連携に関する質問

1. **Q: LLM にどのようなプロンプトを送信すべきですか？**

   - A: プロンプトには、審査対象ドキュメントの内容と、チェック項目の名前・説明を含めます。また、期待される出力形式（JSON 形式で結果、説明、信頼度を含む）も明示します。

2. **Q: LLM の応答をどのようにパースすべきですか？**

   - A: LLM の応答は構造化された JSON 形式を期待し、それをパースして `result`（pass/fail）、`explanation`（説明文）、`confidence_score`（信頼度）などの情報を抽出します。
   - パースに失敗した場合、なぜ失敗したかのエラーメッセージを添え、リトライします。

3. **Q: LLM の処理コストを最適化するには？**
   - A: 将来的にプロンプトキャッシュを利用しますが、現時点では考慮しなくて構いません。

## セキュリティに関する質問

1. **Q: ユーザー権限の管理はどうすべきですか？**
   - A: 審査ジョブの作成、閲覧、結果の上書きなどの操作に対して、適切な権限管理を実装します。ユーザー ID を各操作に記録し、監査証跡を残します。
