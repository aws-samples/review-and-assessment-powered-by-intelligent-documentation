# 審査機能実装要件

## 概要

BEACON システムにおける審査機能の実装要件を定義します。この機能は、アップロードされたドキュメントとチェックリストセットを突き合わせ、各チェック項目への適合性を LLM を用いて判定するものです。

## バックエンド実装要件

### 1. 審査ジョブ管理機能

#### 1.1 審査ジョブの作成

- 新規審査ジョブを作成する API エンドポイントを実装
- 審査ジョブ作成時に、指定されたドキュメントとチェックリストセットの存在を検証
- 審査ジョブ作成後、非同期で処理を開始するためのキューイング機構を実装
- 各チェック項目に対して ReviewResult レコードを作成し、初期状態は pending に設定

#### 1.2 審査ジョブのステータス管理

- 審査ジョブのステータス（pending, processing, completed, failed）を適切に管理
- 全てのチェック項目の処理が完了したら、審査ジョブのステータスを completed に更新
- エラーが発生した場合は、審査ジョブのステータスを failed に更新
- 審査ジョブのキャンセル機能を実装

#### 1.3 審査ジョブの取得

- 審査ジョブ一覧を取得する API エンドポイントを実装
- フィルタリング、ソート、ページネーション機能を実装
- 審査ジョブの詳細情報を取得する API エンドポイントを実装
- 審査結果のサマリー情報（合格/不合格/警告の数）を動的に計算して返す機能を実装

### 2. 審査処理機能

#### 2.1 LLM を用いた審査処理

- チェック項目ごとに LLM を用いた審査処理を実装
- 審査対象ドキュメントとチェック項目の情報を LLM に入力し、適合性を判定
- LLM からの応答を解析し、結果（pass/fail/warning）と説明文を抽出
- 信頼度スコアを計算し、結果と共に保存

#### 2.2 非同期処理の実装

- AWS Step Functions または同等の仕組みを用いて、非同期処理を実装
- チェック項目ごとに個別の処理を行い、結果を DB に保存
- 処理状況を監視し、エラーハンドリングを適切に実装
- タイムアウト処理を実装し、長時間応答がない場合は適切にエラー処理

#### 2.3 階層構造の考慮

- チェックリスト項目の階層構造を考慮した審査処理を実装
- 親項目の結果は、子項目の結果に基づいて計算
- 階層構造を考慮した結果の取得 API を実装

### 3. 審査結果管理機能

#### 3.1 審査結果の取得

- 審査結果一覧を取得する API エンドポイントを実装
- 審査結果の階層構造を取得する API エンドポイントを実装
- フィルタリング機能を実装（結果タイプ別など）

#### 3.2 ユーザーによる上書き機能

- ユーザーが審査結果を上書きする API エンドポイントを実装
- 上書き情報（結果、コメント）を保存
- 上書き後、親項目の結果を再計算する機能を実装

### 4. エラーハンドリングとロギング

- 適切なエラーハンドリングを実装し、クライアントに意味のあるエラーメッセージを返す
- 処理の各ステップでログを記録し、デバッグや監査に役立てる
- 重要なイベント（審査開始、完了、エラーなど）を記録

## フロントエンド実装要件

### 1. 審査ジョブ管理画面

#### 1.1 審査ジョブ一覧画面

- 審査ジョブの一覧を表示
- ステータスに応じた視覚的な表示（色分けなど）
- フィルタリング、ソート機能
- 新規審査ジョブ作成ボタン
- 各ジョブの詳細画面へのリンク

#### 1.2 新規審査ジョブ作成画面

- ジョブ名入力フィールド
- ドキュメント選択機能（既存のドキュメントから選択）
- チェックリストセット選択機能
- 作成ボタンとキャンセルボタン
- バリデーション機能

### 2. 審査結果表示画面

#### 2.1 審査結果サマリー

- 審査ジョブの基本情報（名前、ステータス、作成日時など）
- 審査結果のサマリー（合格/不合格/警告の数）をグラフィカルに表示
- ドキュメントとチェックリストセットの情報

#### 2.2 審査結果詳細

- チェック項目の階層構造を視覚的に表示
- 各項目の結果（合格/不合格/警告）を色分けして表示
- 項目の展開/折りたたみ機能
- 各項目の詳細情報（説明、抽出テキスト、信頼度スコアなど）の表示

#### 2.3 ユーザー上書き機能

- 各審査結果に対するユーザー上書き機能
- 結果の変更（合格/不合格/警告）
- コメント入力フィールド
- 上書き情報の視覚的な表示（元の結果と上書き後の結果の区別）

### 3. リアルタイム更新

- WebSocket または定期的なポーリングを用いて、審査状況をリアルタイムに更新
- 処理中の項目数、完了した項目数などの進捗状況を表示
- 新しい結果が得られた際に、UI を自動的に更新

### 4. レスポンシブデザイン

- モバイルデバイスを含む様々な画面サイズに対応したレスポンシブデザイン
- タッチ操作に最適化されたインターフェース（モバイル向け）

## 技術的考慮事項

### 1. パフォーマンスと最適化

- 大量のチェック項目がある場合でも高速に動作するよう最適化
- 必要に応じて結果の遅延読み込み（Lazy Loading）を実装
- キャッシュ機構を適切に活用

### 2. セキュリティ

- 適切な認証・認可の実装
- 入力値のバリデーションと無害化
- CSRF 対策、XSS 対策などのセキュリティ対策

### 3. テスト

- 単体テスト、統合テスト、E2E テストの実装
- エッジケースのテスト（タイムアウト、エラー発生時など）
- モック LLM を用いたテスト環境の構築

## フォローアップ質問

1. LLM を用いた審査処理において、具体的にどのような形式でプロンプトを構築すべきでしょうか？
2. 審査結果の信頼度スコアはどのように計算すべきでしょうか？LLM の出力から直接取得するのか、別の方法で計算するのか？
3. 審査処理のタイムアウト時間はどの程度に設定すべきでしょうか？
